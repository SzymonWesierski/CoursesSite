{% extends 'base.html.twig' %}

{% block title %}Courses{% endblock %}

{% block body %}

    <div class="cshow-container">
        <div class="cshow-container-left">
            {% if episodeId > 0 %}
                <div class"cshow-watch-container">
                    <div class="cshow-videoplayer-container">
                        <video controls>
                            <source src="{{episode.videoPath}}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    
                    <div class="cshow-details">
                        <h1>
                        {{ episode.name }}
                        </h1>

                        <p class="cshow-text-block">
                            {{ episode.Description }}
                        </p>
                    </div>
                    
                </div>
            {% else %}
                <div class="cshow-details-container">
                    <div class="cshow-course-img">
                        <img
                        src="{{ course.ImagePath }}"
                        />
                    </div>
                    <div class="cshow-details">
                        <h1>
                            {{ course.name }}
                        </h1>

                        <p class="cshow-text-block">
                            {{ course.Description }}
                        </p>

                        <p>
                            Categories:
                            {% for category in course.categories %}
                            {{category.name}}
                            {% endfor %}

                            <h4>Course created by {{course.user.username}}</h4>

                            {% if app.user == course.user %}
                                <p> 
                                    <a 
                                        href="/courses/edit/{{ course.id }}">
                                        Edit course   
                                    </a>
                                </p>
                                
                                <p>
                                    <a 
                                        href="/courses/delete/{{ course.id }}">
                                        Delete course
                                    </a>
                                </p>
                            {% endif %}
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>

            
        <div class="cshow-container-right">

            <div class="cshow-chapters-list-container">
                <h3>Content:</h3>
                {% set episodeIndex = 1 %}
                {% for chapter in course.chapters %}
                        <div class="cshow-chapters-element">
                            <div class="cshow-chapters-element-title" onclick="toggleChapter('{{ loop.index }}')">
                                <h4>{{ chapter.name }}</h4> 
                                <img class="cshow-arrow-right" id="arrow-right-{{ loop.index }}" src="/icons/arrow-right.svg" alt="arrow-right" style="display: inline;">
                                <img class="cshow-arrow-down" id="arrow-down-{{ loop.index }}" src="/icons/arrow-down.svg" alt="arrow-down" style="display: none;">
                            </div>
                            <div class="cshow-chapters-element-episode-container" id="chapter-{{ loop.index }}" data-index="{{ loop.index }}">
                                <ul>
                                    {% for episode in chapter.episodes %}
                                        {% if isPurchased %}
                                            <div class="cshow-chapters-element-episode" onclick="window.location.href='{{ path('show_course', {courseId: course.id, episodeId: episode.id}) }}';">
                                                <li>{{episodeIndex}}. {{ episode.name }}</li>
                                            </div>
                                        {% else %}

                                            {% if episode.isFreeToWatch %}
                                                <div class="cshow-chapters-element-episode" onclick="window.location.href='{{ path('show_course', {courseId: course.id, episodeId: episode.id}) }}';">
                                                    <li>{{episodeIndex}}. {{ episode.name }}</li>
                                                </div>

                                            {% else %}
                                                 <div class="cshow-chapters-element-episode episode-blocked">
                                                    <li>{{episodeIndex}}. {{ episode.name }}</li>
                                                    <img class="lock-img" src="/icons/lock.svg" alt="locked">
                                                </div>
                                            {% endif %}

                                        {% endif %}
                                        
                                        
                                        {% set episodeIndex = episodeIndex + 1 %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endfor %}



            </div>

        </div>
        
    </div>

<script>

    function toggleChapter(index) {
        const chapter = document.getElementById('chapter-' + index);
        const arrowRight = document.getElementById('arrow-right-' + index);
        const arrowDown = document.getElementById('arrow-down-' + index);
        let expandedChapters = JSON.parse(localStorage.getItem('expandedChapters')) || [];

        if (chapter.style.display === 'none' || chapter.style.display === '') {
            chapter.style.display = 'block';
            arrowRight.style.display = 'none';
            arrowDown.style.display = 'inline';
            expandedChapters.push(index);
        } else {
            chapter.style.display = 'none';
            arrowRight.style.display = 'inline';
            arrowDown.style.display = 'none';
            expandedChapters = expandedChapters.filter(i => i !== index);
        }
        localStorage.setItem('expandedChapters', JSON.stringify(expandedChapters));
    }

    document.addEventListener("DOMContentLoaded", function() {
        const chapters = document.querySelectorAll('.cshow-chapters-element-episode-container');
        let expandedChapters = JSON.parse(localStorage.getItem('expandedChapters')) || [];

        if (expandedChapters.length === 0 && chapters.length > 0) {
            chapters[0].style.display = 'block';
            document.getElementById('arrow-right-0').style.display = 'none';
            document.getElementById('arrow-down-0').style.display = 'inline';
            expandedChapters.push(chapters[0].dataset.index);
            localStorage.setItem('expandedChapters', JSON.stringify(expandedChapters));
        }

        expandedChapters.forEach(index => {
            const chapter = document.getElementById('chapter-' + index);
            const arrowRight = document.getElementById('arrow-right-' + index);
            const arrowDown = document.getElementById('arrow-down-' + index);

            if (chapter) {
                chapter.style.display = 'block';
                arrowRight.style.display = 'none';
                arrowDown.style.display = 'inline';
            }
        });
    });

</script>

{% endblock %}